generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id          String   @id @default(cuid())
  phoneNumber String   @unique @map("phone_number")
  name        String?
  email       String?
  address     String?
  city        String?
  state       String?
  zipCode     String?  @map("zip_code")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  conversations Conversation[]
  messages      Message[]
  availabilityChecks AvailabilityCheck[]

  @@map("customers")
}

model Conversation {
  id           String        @id @default(cuid())
  customerId   String        @map("customer_id")
  status       ConversationStatus @default(NEW)
  lastMessageAt DateTime     @default(now()) @map("last_message_at")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  messages     Message[]
  availabilityChecks AvailabilityCheck[]

  @@index([customerId])
  @@index([status])
  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  customerId     String   @map("customer_id")
  body           String
  direction      MessageDirection
  status         MessageStatus @default(PENDING)
  twilioSid      String?  @map("twilio_sid")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  customer       Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([customerId])
  @@index([createdAt])
  @@map("messages")
}

model AvailabilityCheck {
  id             String           @id @default(cuid())
  customerId     String           @map("customer_id")
  conversationId String?          @map("conversation_id")
  address        String
  city           String
  state          String
  zipCode        String           @map("zip_code")
  status         AvailabilityStatus @default(PENDING)
  services       Json?            // Array of available services
  fiberSpeeds    Json?            @map("fiber_speeds")
  internetAir    Boolean?         @map("internet_air")
  notes          String?
  checkedAt      DateTime         @default(now()) @map("checked_at")
  createdAt      DateTime         @default(now()) @map("created_at")

  customer       Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  conversation   Conversation?    @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([customerId])
  @@index([status])
  @@map("availability_checks")
}

enum ConversationStatus {
  NEW
  ADDRESS_REQUESTED
  CHECKING
  RESPONDED
  CLOSED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  READ
}

enum AvailabilityStatus {
  PENDING
  FIBER_AVAILABLE
  INTERNET_AIR_AVAILABLE
  NOT_AVAILABLE
  ERROR
}
